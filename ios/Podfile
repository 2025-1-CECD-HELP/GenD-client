# Resolve react_native_pods.rb with node to allow for hoisting
require Pod::Executable.execute_command('node', ['-p',
  'require.resolve(
    "react-native/scripts/react_native_pods.rb",
    {paths: [process.argv[1]]},
  )', __dir__]).strip

# iOS 최소 버전 설정
platform :ios, '15.1'
prepare_react_native_project!

# =============================================
# Firebase 정적 프레임워크 설정 (필수!)
# React Native Firebase 공식 문서 권장 설정
# =============================================
use_frameworks! :linkage => :static
$RNFirebaseAsStaticFramework = true

# 기존 USE_FRAMEWORKS 환경변수 설정 제거 (충돌 방지)
# linkage = ENV['USE_FRAMEWORKS']
# if linkage != nil
#   Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
#   use_frameworks! :linkage => linkage.to_sym
# end

target 'GenD' do
  config = use_native_modules!

  # React Native 기본 설정
  use_react_native!(
    :path => config[:reactNativePath],    
    :app_path => "#{Pod::Config.instance.installation_root}/..",
    :hermes_enabled => true,
    :fabric_enabled => false
  )

  # Firebase 관련 모듈 설정 (modular_headers 필수)
  pod 'Firebase', '~> 11.12.0', :modular_headers => true
  pod 'FirebaseCoreInternal', '~> 11.12.0', :modular_headers => true
  pod 'GoogleUtilities', '~> 8.0', :modular_headers => true
  pod 'FirebaseCore', '~> 11.12.0', :modular_headers => true
  pod 'Firebase/Messaging', '~> 11.12.0', :modular_headers => true

  # 카카오 로그인 모듈 설정
  pod 'KakaoSDKCommon', '~> 2.22.0'
  pod 'KakaoSDKAuth', '~> 2.22.0'
  pod 'KakaoSDKUser', '~> 2.22.0'

  post_install do |installer|
    # React Native 기본 post_install 설정
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )
    
    # =============================================
    # Firebase 모듈 인터페이스 문제 해결
    # =============================================
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # iOS 최소 배포 타겟 통일
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.1'
        
        # Firebase 모듈 인터페이스 검증 문제 해결
        if target.name == 'FirebaseCoreInternal'
          config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'NO'
        else
          config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'YES'
        end
        
        # Swift 컴파일 최적화
        config.build_settings['SWIFT_COMPILATION_MODE'] = 'wholemodule'
        
        # 아키텍처 설정
        config.build_settings["EXCLUDED_ARCHS[sdk=iphonesimulator*]"] = "arm64"
        
        # 모듈 맵 생성 강제 활성화
        config.build_settings['DEFINES_MODULE'] = 'YES'
      end
    end
    
    # =============================================
    # Firebase 정적 프레임워크 전역 설정
    # =============================================
    installer.pods_project.build_configurations.each do |config|
      config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= ['$(inherited)']
      config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'FIREBASE_VERSION=11.12.0'
      
      # 모듈 맵 파일 생성 강제
      config.build_settings['MODULEMAP_FILE'] = '$(inherited)'
    end
  end
end
